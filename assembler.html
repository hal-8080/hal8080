<!--
#             HAL8080 Processor               #
# Kasper, Dennis, Tjeerd, Nick, Oussama 2020  #
#                 Assembler                   #
#     Webapp to assemble assemblyHal code     #
# "No working processor but at least we       #
# have proper syntax highlighting!" - khm     #
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
  <meta name="viewport" content="width=device-width" />
  <link rel="icon" href="hal8080.png">
  <title>Hal8080 Assembler</title>
  <link href="./assembler/halfmoon.min.css" rel="stylesheet" />
  <style>
    #bigpage {
        transition: 0.5s;
    }
    .highlight {
        background-color: lightslategray;
    }
  </style>
</head>
<body class="with-custom-webkit-scrollbars with-custom-css-scrollbars" data-dm-shortcut-enabled="true" data-sidebar-shortcut-enabled="true" data-set-preferred-mode-onload="true">
    <div class="modal ie-scroll-fix" id="usage" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="width: 80vw;">
                <a href="#" class="close" role="button" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </a>
                <!-- Explenation of instruction set -->
                <h1>Hal8080 Instruction Set</h1>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse sodales, lacus id laoreet accumsan, <br />
                    turpis nunc auctor est, eu congue mi orci sed ex. Nam scelerisque fermentum nulla eu suscipit. <br />
                    Phasellus nunc justo, gravida eu interdum a, varius sit amet odio. Proin sit amet consectetur velit. <br />
                    Donec non luctus augue, ut viverra massa. Phasellus commodo vel nisi at efficitur. <br />
                    Cras eu hendrerit leo, nec mollis enim. Vivamus nec enim id dui viverra pretium. <br />
                    Sed eu nulla est. Vestibulum vitae augue id turpis volutpat scelerisque ut sit amet leo. <br />
                    Cras facilisis dapibus purus dapibus consectetur. Sed quis congue nisl.<br />
                    Proin vitae massa eu nunc condimentum ultrices et ac nisi. Proin elit metus, semper vel commodo in, <br />
                    imperdiet non eros. Aenean ac dapibus ipsum, at ultrices velit. <br />
                    Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. <br />
                    Maecenas finibus ac ante eu pretium. Sed euismod pulvinar venenatis. Suspendisse vitae nibh nunc.<br />
                    Mauris nec feugiat ligula. Phasellus fermentum purus non ante sagittis, eget sagittis urna rhoncus. <br />
                    Mauris id molestie arcu, in cursus ipsum. Vivamus faucibus mauris ut lectus lacinia accumsan. <br />
                    Phasellus non ante euismod, volutpat urna laoreet, tempor risus. Proin convallis purus id euismod molestie. <br />
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. In feugiat velit nec nisl varius viverra.<br />
                    Pellentesque ante sapien, facilisis imperdiet elit eu, aliquam faucibus leo. Mauris convallis mi nec mi commodo, <br />
                    vitae blandit lorem egestas. Cras mi quam, venenatis vitae erat tempor, tempor pulvinar mauris. <br />
                    Nam sodales consequat ultricies. Sed vestibulum congue hendrerit. Proin eget quam nec elit convallis iaculis. <br />
                    Sed eleifend orci pulvinar, egestas lorem ornare, egestas enim. Etiam sit amet suscipit mi. <br />
                    Nulla sit amet lacus tincidunt, fringilla quam sit amet, congue augue. Etiam eget vulputate lacus. <br />
                    Nulla nibh purus, blandit eu vehicula vel, consequat nec turpis. <br />
                    Cras dolor mi, mattis in tincidunt ut, tincidunt in augue. <br />
                    Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. <br />
                    Pellentesque ut semper mi. Donec tempus orci in massa imperdiet placerat.<br />
                    Phasellus ornare mauris id enim vestibulum, dictum viverra urna tempor. <br />
                    Ut varius est vel mi feugiat, sit amet vestibulum justo lacinia. <br />
                    Duis mollis, tortor vel fringilla varius, nibh nunc porta tellus, ac blandit neque odio in est. <br />
                    Suspendisse sed pellentesque arcu, a maximus eros. Quisque varius placerat orci et tincidunt. <br />
                    Proin quis pretium odio, et luctus quam. Aliquam sit amet sodales odio, id mollis mi. <br />
                    Proin porta vehicula lectus, ut dictum diam luctus in. Vestibulum sapien libero, tristique a viverra nec, dapibus vel sem.
                </p>
            </div>
        </div>
    </div>
    <div id="bigpage" class="page-wrapper with-navbar with-sidebar">

        <div class="sticky-alerts"></div>

        <nav class="navbar d-flex justify-content-center">
            <div class="navbar-content">
                <img src="hal8080.png" alt="logo" style="width: 4rem; margin-right: 2rem;">
                <h1>Hal8080 Assembler</h1>
            </div>
        </nav>

        <!-- Content wrapper start -->
        <div class="container" style="margin-top: 6rem; height: calc(100% - 14rem);">
            <div id="editor" style="height: 100%; border-radius: 1rem; box-shadow: inset;"></div>
            <div class="progress">
                <div id="pbar" class="progress-bar bg-secondary progress-bar-animated highlight-dark" role="progressbar" style="width: 0%; transition: 0.1s;" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="text-center">
                <input id="filename" type="text" class="form-control d-inline" style="width: 20rem;" placeholder="filename">
                <button id="assembleBtn" class="btn btn-success" type="button" style="background-color: #58f00a; color: #25282c; font-weight: bold;">Assemble</button>
                <a href="#usage" class="btn" role="button">Usage</a>
                <button id="saveBtn" class="btn btn-primary" type="button">Save</button>
                <!-- <button id="loadBtn" class="btn btn-primary" type="button">Load</button> -->
            </div>
            <div class="text-center" style="padding-top: 0.5rem;">
                Kasper, Dennis, Tjeerd, Nick, Oussama | 2020-10-29 | Univeristy of Twente | <a href="https://github.com/hal-8080/hal8080">github</a>
            </div>
        </div>

    </div>
    <script src="./assembler/halfmoon.min.js"></script>   <!-- Load dark style: Halfmoon JS -->
    <script src="./assembler/ace.min.js"></script>
    <script src="./assemblyhal/theme/theme-assemblyhal.js"></script>
    <script src="./assemblyhal/syntaxes/mode-assemblyhal.js"></script>
    <!-- Assembler Script -->
    <script>

        //==========================================\\
        //                  EDITOR                  \\
        //==========================================\\

        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/assemblyhal");
        editor.getSession().setMode("ace/mode/assemblyhal");

        // Preload hello world :-)
        editor.setValue(
`#             HAL8080 Processor               #
# Kasper, Dennis, Tjeerd, Nick, Oussama 2020  #
#              Hello World Program            #
# Simple hello world.                         #
# Outputs hello on display                    #
@test@ = x"AA"
@seg0@ = "11111111"

BA @start # Jump to start.
arr1:       PUT x"0001"         # First absolute display value
            PUT x"000F"         # Second display value
            PUT x"000A"         # End with F for easy program. 
            PUT x"FFFF"         # (Remember we can use last bit as flag since display has 7 bits.)
start:      SETHI $r0, @arr1>
            SETLO $r1, @arr1<
loop:       LD $r2, $IR
            CP $r3, $r2
            SHIFTR $r3, 7
            BZERO $r3, @end
            ST $r2, @seg0@
            ADD $r1, 2;
            BA @loop
end:        BA @end`
        );
        editor.clearSelection();
        editor.focus();

        //==========================================\\
        //                   UTILS                  \\
        //==========================================\\

        /***
         * String Enum of status codes.
         */
        let status = {
            "info"   : "primary",
            "success": "success",
            "warning": "secondary",
            "error"  : "danger"
        }
        /***
         * popup - Success popup.
         * @param {('info'|'success'|'warning'|'error')} type - type of the popup.
         * @param {string} title - Title of the alert.
         * @param {string} text - Text of the alert.
         */
        function popup(type, title, text) {
            if (!text) {text = title; title = type.charAt(0).toLocaleUpperCase() + type.slice(1);}
            halfmoon.initStickyAlert({
                content: text,
                title: title,
                alertType: `alert-${status[type]}`,
                fillType: "filled-lm"
            });
        }

        let progress = 0;
        /***
         * Set the percentage of the progress bar.
         * @param {number} percent - The percentage from 0-100.
         */
        function setProgress(percent) {
            progress = percent;
            document.getElementById("pbar").style.width = `${percent}%`;
        }

        /***
         * Gets the file name with extension for saving / assembling.
         * @param {string} extension - The extension to use.
         */
        function getFileName(extension) {
            return `${document.getElementById("filename").value || 'ram'}.${extension}`;
        }

        function testPopup(){
            popup("warning", "test");
            setProgress(100);
            downloadStr("hello", getFileName('bin'));
        }
    

        /***
         * downloadStr - Downloads a string.
         * @param {string} str - String to download.
         * @param {string} filename - filename to use.
         */
        function downloadStr(str, filename) {
            let hiddenElement = document.createElement('a');
            hiddenElement.href = 'data:attachment/text,' + encodeURIComponent(str);
            hiddenElement.target = '_blank';
            hiddenElement.download = filename;
            hiddenElement.click();
        }

        //==========================================\\
        //               SAVE/LOAD FILE             \\
        //==========================================\\
        const bigpage = document.getElementById('bigpage');
        function highlight(e) {
            bigpage.classList.add('highlight')
        }
        function unhighlight(e) {
            bigpage.classList.remove('highlight')
        }
        ;['dragenter', 'dragover'].forEach(eventName => {
            bigpage.addEventListener(eventName, highlight, false)
        })
        ;['dragleave', 'drop'].forEach(eventName => {
            bigpage.addEventListener(eventName, unhighlight, false)
        })
        // On file load, replace contents of the screen.
        function loadFile(e) {
            e.preventDefault();
            let fr = new FileReader();
            fr.onload=function(){
                editor.setValue(fr.result);
                editor.clearSelection();
                editor.focus();
            }
            fr.readAsText(e.dataTransfer.files[0]);
        }
        // Load the code when file is dropped on screen.
        bigpage.addEventListener('drop', loadFile, false);
        window.addEventListener('dragover', function(e){e.preventDefault()}, false);
        // On file save, download .assh file with the contents of the screen.
        function saveFile() {
            // popup("info", editor.getValue());
            downloadStr(editor.getValue(), getFileName('assh'));
        }
        // Save the code when the button is pressed.
        document.getElementById('saveBtn').addEventListener('click', saveFile);
        // Also on ctrl + s
        var isCtrl = false;
        document.onkeyup=function(e){
            if (e.keyCode == 17) isCtrl = false;
            if (e.keyCode == 83 && isCtrl) saveFile();
        }
        document.onkeydown=function(e){
            if(e.keyCode == 17) isCtrl = true;
            if(e.keyCode == 83 && isCtrl == true) return false;
        }

        //==========================================\\
        //                ASSEMBLER                 \\
        //==========================================\\

        const registers = {
            // R       NUM
            "r0":     "0000",
            "r1":     "0001",
            "r2":     "0010",
            "r3":     "0011",
            "r4":     "0100",
            "r5":     "0101",
            "r6":     "0110",
            "r7":     "0111",
            "r8":     "1000",
            "r9":     "1001",
            "rA":     "1010", // Assembly reserved
            "rB":     "1011",
            "rC":     "1100",
            "rD":     "1101",
            "rE":     "1110",
            "rF":     "1111",
            "RET":    "0000", // Start over
            "m1":     "0001",
            "m2":     "0010",
            "m3":     "0011",
            "dA":     "0100", // Assembly reserved
            "dB":     "0101",
            "dC":     "0110",
            "dD":     "0111",
            "dE":     "1000",
            "dF":     "1001",
            "dAD":    "1010",
            "dVAL":   "1011",
            "dPC":    "1100",
            "dIR":    "1101",
            "PC":     "1110",
            "IR":     "1111",

        };
        const instArithmetic = { //00
            //INST   F 1234
            "AND":    "0000",
            "NAND":   "0001",
            "OR" :    "0010",
            "ORN":    "0011",
            "ADD":    "0100",
            "MUL":    "0101", 
            "DIV":    "0110",
            "XOR":    "0111",
            "SHIFTL": "1000",
            "SHIFTR": "1001",
            "INV":    "1010",
            "POW":    "1011",
            "SUB":    "1100",
            "DLUT":   "1101", //Display lookup (not used?)
            "CP":     "1110",
            "RAND":   "1111"
        }
        const instMemory = { //01
            //I   l/s
            "LD": "0",
            "ST": "1"
        }
        const instDisp = { //10
            //INST OP3 H/C
            "DISPCL":  ["10", "-"],
            "DISPCM":  ["01", "-"],
            "DISPCR":  ["00", "-"],
            "DISPRCL": ["10", "0"],
            "DISPRCM": ["01", "0"],
            "DISPRCR": ["00", "0"],
            "DISPRHL": ["10", "1"],
            "DISPRHR": ["00", "1"]
        }
        const instBranch = { //11-i0
            //INST    COND
            "BNEG":  "0000",
            "BZERO": "0010",
            "BA":    "0100",
            "CALL":  "0110",
            "RET":   "1000"
        }
        const instSet = { //11-i1
            //INST   H/L
            "SETHI": "1",
            "SETLO": "0"
        }
        const regexPreamble = /(#(?:.|\n#)*)/m;
        const regexEmptyOrComment = /^\s*(?:#.*)?\s*/g;
        const regexComment = /#.*/g;
        const regexAddress = /(?<address>@(?<aLabel>\w+)(?<aVar>@)?(?<aHiLo>[<>])?)/g;
        const regexConstant = /(?<hex>x"(?<hexval>[0-9A-F]*)")|(?<bin>"(?<binval>[01]*)")|(?<dec>\d*)/;
        const masterRegex = /^(?<label>(?<lLabel>\w+):)?\s*(?<instruction>[A-Z]*)?\s*(?<Rd>\$(?<RdN>\w+))?\s*,?\s*(?<Rs>\$(?<RsN>\w+))?(?<address>@(?<aLabel>\w+)(?<aVar>@)?(?<aHiLo>[<>])?)?\s*(?<cAssign>=)?\s*(?<C>\d+|"(?:[01]{1,5}|[01]{8}|[01]{16})"|x"(?:[0-9A-F]{1,2}|[0-9A-F]{4})")?/

        /***
         * Converts assemblyhal constant type to a number.
         * @param {string} str - The string that contains the constant.
         * @param {number} linenum - For errors :P
         * @return {number} the integer value.
         */
         function constToNum(str, linenum = -1) {
            let info = regexConstant.exec(str).groups;
            let parsed = NaN;
            if (info.hex) parsed = parseInt(info.hexval, 16);
            if (info.bin) parsed = parseInt(info.binval,  2);
            if (info.dec) parsed = parseInt(str, 10);
            if (isNaN(parsed)) throw {
                title: 'Parse Error', 
                message: `Parse Error on line <b>${linenum}</b>: Constant ${str} is not a valid constant!`
            };
            return parsed;
        }

        /**
         * Converts a (negative) number to binary 2s complement of fixed length
         * @param {number} num - the number to convert.
         * @param {number} length - length of the binary string.
         * @return {string} the binary string
         */
        function numToBin(num, length) {
            let str = (num & ((2**length)-1)).toString(2);
            while(str.length < length) {str = '0' + str};
            return str;
        }

        let preVars = [
            ["@_LAST_@", constToNum('x"FFFF"')],
            ["@_MEEP_@", 55]
        ]

        function assemble() {
            // Get the input and start progress.
            console.log('Assembler started!');
            let input = editor.getValue();
            setProgress(1);
            console.log('Step 1: load the preamble and get rid of other comments.');
            // This allows us to inject some instructions more easily.
            let preamble = input.match(regexPreamble);
            if (preamble.length > 0) preamble = preamble[0];
            console.log('Preamble: \n' + preamble);
            // input = input.replace(regexEmptyOrComment, ''); // Cut line comments and empty lines
            input = input.replace(regexComment, ''); // Cut remaining comments
            console.log('Step 2: First pass. Split addresses & Find labels.');
            // In this pass we run through the program and replace all pseudo
            // assembly instructions.
            // Replace long address in ST, LD and B[A|ZERO|NEG] with 3 instructions
            // using the assembler register. Note that implementation differs for debug mode.
            let lines = input.split('\n');
            let inDebugMode = false;
            let matches = [];
            // To find addresses for labels & store assembler vars. Keep track of instructions and addresses.
            let assVars = new Map(preVars);
            let iCnt = 0; // Instruction counter.
            for (let i = 0; i < lines.length; i++) {
                let l = masterRegex.exec(lines[i]).groups;
                matches.push(l); // For further use.
                // If we encounter constant assignment:
                if (l.cAssign) assVars.set(l.address, constToNum(l.C, i+1));
                // To find address, just store the instruction counter x2 (word aligned) to name of label if found.
                if (l.label) assVars.set(l.lLabel, iCnt * 2);
                if (l.instruction) {
                    // If there is an address specified without hi/lo selector. Always update (except for PUT and constant assignments).
                    if (l.instruction !== "PUT" && l.address && !l.aHiLo) {
                        lines[i] = `${l.label || ''} SETHI $rA, ${l.address}> && SETLO $rA, ${l.address}< && ${l.instruction}${(l.Rd ? ` ${l.Rd},` : '')} $rA`;
                        iCnt += 2; // We will add 2 extra instructions.
                    }
                    iCnt++; // Raise instruction counter.
                }
            }
            console.log("First disection:");
            console.dir(matches);
            console.log("After first pass:");
            console.dir(lines);
            console.log("Assembler Vars:");
            console.dir(assVars);
            console.log("Step 3: Second Pass; replace the addresses with corresponding values. Decimalise the constants.");
            for (let i = 0; i < lines.length; i++) {
                let l = matches[i];
                // Replace all constants with decimals (makes stuff easier next run)
                if (l.C) {
                    let num = constToNum(l.C, i+1);
                    lines[i] = `${l.label || ''} ${l.instruction || ''} ${(l.Rd ? ` ${l.Rd},` : '')} ${num}`;
                    if (l.cAssign) lines[i] = ''; // Remove assignments. No longer useful.
                }
                // Replace all address values with constant decimals.
                lines[i] = lines[i].replace(regexAddress, (match, address, aLabel, aVar, aHiLo) => {
                    aVar = aVar || '';
                    let val = assVars.get(`${aVar}${aLabel}${aVar}`);
                    console.log(`getting: ${aVar}${aLabel}${aVar} = ${val} (${val >>> 8} - ${val & 255})`);
                    if (val == undefined ||  val == null) throw {
                        title: 'Var Error',
                        message: `Variable Error on line <b>${i+1}</b>: Address ${aLabel} is undefined!`
                    };
                    switch (aHiLo) {
                        case ">": return val >>> 8; // Logical right shift because we only have 16 bits.
                        case "<": return val & 255; // Only get the lowest 8 bits.
                        default: return val;
                    }
                });
                lines[i] = lines[i]
            }
            console.log("After second pass:");
            console.dir(lines);
            console.log("Step 4: Third pass. Convert to assembly instructions.");
            let data = [];
            for (let i = 0; i < lines.length; i++) {
                let sublines = lines[i].split("&&");
                for (let j = 0; j < sublines.length; i++) {
                    let l = masterRegex.exec(sublines[j]).groups;
                    // Only encode if there is instruction :P
                    if (l.instruction) {
                        // Perform checks to find instruction type.
                        let nameData = null;
                        // PUT
                        if (l.instruction == "PUT") {
                            // Check constant
                            if (!l.C) throw {
                                title: "Parse Error", 
                                message: `Parse Error on line <b>${i+1}</b> (${l.instruction}). Missing constant!`
                            };
                            if (l.C < -32768 || l.C > 65535) throw {
                                title: "Constant Error", 
                                message: `Constant Error on line <b>${i+1}</b> (${l.instruction}). Out of range constant: ${l.C} only -32768 to 65535 is allowed!`
                            };
                            data.push(numToBin(l.C, 16)); continue; // Push full constant to 16 bits.
                        }
                        // ARITHMETIC
                        nameData = instArithmetic(l.instruction)
                        if (nameData) {
                            // We always have an $Rd register.
                            if (!l.Rd) throw {
                                title: "Parse Error", 
                                message: `Parse Error on line <b>${i+1}</b>. Missing Rd register!`
                            };
                            // Either we also have a $Rs register or we have a constant or neither.
                            if (l.Rs) {
                                data.push(`000${registers[l.Rd]}${nameData}0${registers[l.Rs]}`);
                            } else if (l.C) {
                                // Check if constant is in range (5 bits signed max)
                                if (l.C < -16 || l.C > 31) throw {
                                    title: "Constant Error", 
                                    message: `Constant Error on line <b>${i+1}</b> (${l.instruction}). Out of range constant: ${l.C} only -16 to 31 is allowed!`
                                };
                                data.push(`000${registers[l.Rd]}${nameData}${numToBin(l.C, 5)}`); continue;
                            } else {
                                throw {
                                    title: "Syntax Error", 
                                    message: `Arithmatic operation on line <b>${i+1}</b> (${l.instruction}). Expects a register or constant!`
                                };
                            }
                        }
                        // MEMORY
                        nameData = instMemory(l.instruction);
                        if (nameData) {
                            // We always have an $Rd and $Rs register.
                            if (!l.Rd) throw {
                                title: "Parse Error", 
                                message: `Parse Error on line <b>${i+1}</b> (${l.instruction}). Missing $Rd register!`
                            };
                            if (!l.Rs) throw {
                                title: "Parse Error", 
                                message: `Parse Error on line <b>${i+1}</b> (${l.instruction}). Missing $Rs register!`
                            };
                            data.push(`010${registers[l.Rd]}${nameData}0000${registers[d.Rs]}`); continue;
                        }
                        // DISPLAY
                        nameData = instDisp(l.instruction);
                        if (nameData) {
                            //TODO HELP constant 2. Do into 10 bits Merge two constants previous pass

                            // In this case we only have $Rs but regex only sees the $Rd so ¯\_(ツ)_/¯
                            if (l.Rd) {
                                data.push(`100${nameData[0]}00${nameData[1]}0000${registers[l.Rd]}`); continue;
                            } else if (l.C) {
                                // Check range
                                if (l.C < -512 || l.C > 1023) throw {
                                    title: "Constant Error", 
                                    message: `Constant Error on line <b>${i+1}</b> (${l.instruction}). Out of range constant: ${l.C} only -512 to 1023 is allowed! Try checking your display constants.`
                                };
                                data.push(`101${nameData[0]}0${numToBin(l.C, 10)}`); continue;
                            } else {
                                throw {
                                    title: "Syntax Error", 
                                    message: `Display operation on line <b>${i+1}</b> (${l.instruction}). Expects a value!`
                                };
                            }
                        }
                        // BRANCH
                        nameData = instBranch(l.instruction);
                        if (nameData) {
                            // In this case we only have $Rs but regex only sees the $Rd so ¯\_(ツ)_/¯
                            if (!l.Rd) throw {
                                title: "Parse Error", 
                                message: `Parse Error on line <b>${i+1}</b> (${l.instruction}). Missing $Rs register!`
                            };
                            data.push(`1100000${nameData}0${registers[l.Rd]}`); continue;
                        }
                        // SET
                        nameData = instSet(l.instruction);
                        if (nameData) {
                            // We always have an $Rd and a constant
                            if (!l.Rd) throw {
                                title: "Parse Error", 
                                message: `Parse Error on line <b>${i+1}</b> (${l.instruction}). Missing $Rd register!`
                            };
                            if (!l.C) throw {
                                title: "Parse Error", 
                                message: `Parse Error on line <b>${i+1}</b> (${l.instruction}). Missing constant!`
                            };
                            // Check range
                            if (l.C < -128 || l.C > 255) throw {
                                title: "Constant Error", 
                                message: `Constant Error on line <b>${i+1}</b> (${l.instruction}). Out of range constant: ${l.C} only -128 to 255 is allowed!`
                            };
                            data.push(`111${registers[l.Rd]}${nameData}${numToBin(l.C, 8)}`); continue;
                        }
                        throw {
                            title: "Instruction Error", 
                            message: `Unknown instruction on line <b>${i+1}</b> (${l.instruction})!`
                        };
                    }
                    
                }
            }
            console.log("After third pass:");
            console.dir(data);

            // popup("info", lines.length);
            // console.dir(lines.length);
            popup("info", input.replaceAll('\n', '<br>'));


            // Note for philosophy:
            // Let's keep this assembler simple
            // Each instruction lives in 16 bits
            // The 16 bits must always be filled.
            // PUT expects 16 bits -> directly to memory
            // SETHI/SETLO expects 8 bits
            // Arithmetic expects 5 bits
            // Other inputs can only be fixed with registers
            // $rA and $dA are reserved for us to fix this.
            // The first pass is to add instructions for this.
        }

        function safeAssemble() {
            try {
                assemble();
            } catch (e) {
                console.error(e);
                popup("error", e.title, e.message);
            }
        }
        // Run the assembler when the button is pressed.
        document.getElementById('assembleBtn').addEventListener('click', safeAssemble);
        
    </script>
</body>
</html>